## NER service (http сервер для распознавания именованных сущностей)

### Работа сервера
Скрипт bin/ner-server/ner-server.py запускает работу http сервера. Сервер ожидает запросов с json следующего формата:

    {
        "Language": "<язык текста>",
        "Data": "<текст на соответствующем языке для обработки>"
    }
Ожидается, что поле "Language" содержит строковый формат и принимает значения:
- "English"
- "Russian"

Поле "Data" должно содержать текст на соответствующем языке в строковом формате.

Сервер обрабатывает текст (выделяет именованные сущности) и возвращает ответ в виде json следующего формата:

    {
        "Satatus": "<статус ответа>",
        "Error_num": <номер ошибки>,
        "Response": <результат обработки текста: список из пар (слово, тип именованной сущности)>
    }
Поле "Status" может иметь два строковых значения:
- "Error" - в случае какой-либо ошибки
- "Ok" - в случае успешной обработки текста

Поле "Error_num" может принимать следующие целочисленные значения:
- 0 - в случае отсутствия ошибок
- Целое число номера ошибки

### Работа клиента
Клиент считывает предложения из файлов ner-client/bin/english_text.txt и ner-client/bin/russian_text.txt (один текст должен быть записан в одну строку, то есть без символа "\n"), и далее по одному отправляет их на сервер.

### Оценка скорости обработки
При каждом получении запроса, в лог сервера записывается время работы модели NER.
При каждой отправке запроса с клиента в терминал выводится время получения ответа от сервера, в конце работы клиента выводится среднее время получения ответа от сервера.

### Работа модели NER
Используются две модели:
- Для английского языка: предобученная модель "en_core_web_sm" из библиотеки spacy
- Для русского языка: pytorch-ner (https://github.com/dayyass/pytorch-ner/tree/main)

Модель для распознавания сущностей на русском языке обучалась на данных: https://github.com/dayyass/pytorch-ner/tree/main/data/conll2003.
При этом было достигнуто следующее качество на тестовой выборке:
- loss: 0.7296910180557871
- f1 B-LOC: 0.22904903344762156
- f1 B-MISC: 0.09460520021204245
- f1 B-ORG: 0.23581410745407486
- f1 B-PER: 0.17305354071600662
- f1 I-LOC: 0.025884695447551814
- f1 I-MISC: 0.023987949782139303
- f1 I-ORG: 0.08882763189155037
- f1 I-PER: 0.13067403080765963
- f1 O: 0.8819344220061937
- f1-weighted: 0.8565391507028522

### Параметры
Перед запуском ner-server.py и ner-client.py необходимо отредактировать файл настроек configurations/input/configurations-1.json. Описание параметров, их формат и ограничения на них описаны в constraints/constraint.json.

### Логирование
Логи запуска сервера сохраняются в папку ner-server/logs. Параметры с которыми был последний фактический запуск сервера сохраняются в папку configurations/output.
Логи клиента выводятся в терминал.

### Запуск:
_Запускать модули и ставить все зависимости рекомендуется в виртуальном окружении!_

Перед запуском необходимо установить зависимости (если запуск производится не через docker): **pip install -r requirements.txt**

А так же скачать предобученную модель для английского языка: **python3 -m spacy download en_core_web_sm**

Есть несколько способов запуска сервера: 
- Через терминал или tmux (из директории ner-server/bin): **python3 ner-server.py ../configurations/input/configurations-1.json ../constraints/constraint.json**
- Через службу systemd, рекомендуется это делать с помощью Gunicorn (для этого необходимо создать файл /lib/systemd/system/ner-server.service): **sudo systemctl start ner-server.service**
- Через docker:
    1. Собрать образ (из директории ner-server): **docker build -t ner .**
    2. Запустить образ: **docker run ner**

Запуск клиента:
- Через терминал или tmux (из директории ner-client/bin): **python3 ner-client.py**